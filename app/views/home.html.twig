{% extends "app.html.twig" %}

{% block headtext %}
    <title>What is the weather in my area?</title>
    <meta name="description" content="Check to see the local weather where I am." />

{% endblock %}

{% block head %}

    <!-- bootstrap begin -->

    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">


    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <!-- bootstrap end -->
    <!-- jquery easyautocomplete.com begin -->
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="/local-weather/vendor/EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>

    <link rel="stylesheet" href="/local-weather/vendor/EasyAutocomplete-1.3.5/easy-autocomplete.min.css">
    <link rel="stylesheet" href="/local-weather/vendor/EasyAutocomplete-1.3.5/easy-autocomplete.themes.min.css">

    <!-- jquery easyautocomplete.com end -->

    <link rel='stylesheet' href="/local-weather/files/style.css" />

    <script type="text/javascript">

        // Weather Underground API data
        function getWeather(locationUrl) {
            $.ajax({
                url : 'http://api.wunderground.com/api/' + api + '/geolookup/conditions/forecast10day/q/' + locationUrl ,
                dataType : "jsonp",
                success : function(parsed_json) {
                    var city = parsed_json['location']['city'];
                    var state = parsed_json['location']['state'];
                    var country = parsed_json['location']['country'];
                    var countryName = parsed_json['location']['country_name'];
                    var temp_f = parsed_json['current_observation']['temp_f'];
                    var temp_c = parsed_json['current_observation']['temp_c'];
                    var feels_f = parsed_json['current_observation']['feelslike_f'];
                    var feels_c = parsed_json['current_observation']['feelslike_c'];
                    var weather = parsed_json['current_observation']['weather'];
                    var humidity = parsed_json['current_observation']['relative_humidity'];
                    var windDir = parsed_json['current_observation']['wind_dir'];
                    var windMPH = parsed_json['current_observation']['wind_mph'];
                    var windKPH = parsed_json['current_observation']['wind_kph'];
                    var icon = parsed_json['current_observation']['icon_url'];
                    var forPOP1 = parsed_json['forecast']['simpleforecast']['forecastday'][0]['pop'];

                    //This is from forecast High & Low Temps
                    var forTempHighF = parsed_json.forecast.simpleforecast.forecastday[0].high.fahrenheit;
                    var forTempHighC = parsed_json['forecast']['simpleforecast']['forecastday'][0]['high']['celsius'];
                    var forTempLowF = parsed_json.forecast.simpleforecast.forecastday[0].low.fahrenheit;
                    var forTempLowC = parsed_json['forecast']['simpleforecast']['forecastday'][0]['low']['celsius'];


                    //Non US countries without states will use their country name
                    if(!state || state == '') {
                        state = countryName;

                    }



                    //This is for the background image to change based on the current weather
                    var backImage;

                    if(weather == 'Partly Cloudy' || weather == 'Mostly Sunny' || weather == 'Partly Sunny' || weather == 'Scattered Clouds') {
                        backImage = 'partly-cloudy-fotonin-com.jpg';
                    } else if (weather == 'Cloudy' || weather == 'Mostly Cloudy' || weather == 'Overcast') {
                        backImage = 'cloudy-fotonin-com.jpg';
                    } else if (weather == 'Chance Tstorms' || weather == 'Tstorms') {
                        backImage = 't-storms-fotonin-com.jpg';
                    } else if (weather == 'Chance Snow' || weather == 'Snow') {
                        backImage = 'snow-fotonin-com.jpg';
                    } else if (weather == 'Chance Sleet' || weather == 'Sleet') {
                        backImage = 'sleet-fotonin-com.jpg';
                    } else if (weather == 'Chance Rain' || weather == 'Rain') {
                        backImage = 'rain-fotonin-com.jpg';
                    } else if (weather == 'Chance Flurries' || weather == 'Flurries') {
                        backImage = 'flurries-fotonin-com.jpg';
                    } else if (weather == 'Fog' || weather == 'Hazy'){
                        backImage = 'fog-fotonin-com.jpg';
                    } else {
                        backImage = 'sunny-fotonin-com.jpg';
                    }


                    $('body').css("background-image","url(../images/" + backImage + ")");


                    // Variables for the temp metric switch to change the C | && F |
                    var degreeF = '&deg;F &#124;';
                    var switchF = '&deg;F';

                    var degreeC = '&deg;C &#124;';
                    var switchC = '&deg;C';

                    // Variables
                    var temp, feels, tempHigh, tempLow, degreeSymbolBar, degreeSymbol, switchSymbol, unit;


                    // If in F country, use F, otherwise C
                    if(country == 'US'|| country == 'BS' || country == 'BH' || country == 'GC' || country == 'American Samoa') {
                        unit = "f";
                        temp = temp_f;
                        feels = feels_f;
                        tempHigh = forTempHighF;
                        tempLow = forTempLowF;
                        wind = windMPH + ' mph ';
                        degreeSymbolBar = degreeF;
                        degreeSymbol = switchF;
                        switchSymbol = switchC;
                        writeToPage();

                    } else {
                        unit = "c";
                        temp = temp_c;
                        feels = feels_c;
                        tempHigh = forTempHighC;
                        tempLow = forTempLowC;
                        wind = windKPH + ' kph ';
                        degreeSymbolBar = degreeC;
                        degreeSymbol = switchC;
                        switchSymbol = switchF;
                        writeToPage();
                    }

                    //Switch when clicking the linked temp metric to the other unit
                    $('#switchMetric').click(function() {
                        if(temp == temp_f) {
                            unit = "c";
                            temp = temp_c;
                            feels = feels_c;
                            degreeSymbol = switchC;
                            degreeSymbolBar = degreeC;
                            switchSymbol = switchF;
                            wind = windKPH + ' kph ';
                            tempHigh = forTempHighC;
                            tempLow = forTempLowC;
                            writeToPage();
                        } else {
                            unit = "f";
                            temp = temp_f;
                            feels = feels_f;
                            degreeSymbol = switchF;
                            degreeSymbolBar = degreeF;
                            switchSymbol = switchC;
                            wind = windMPH + ' mph ';
                            tempHigh = forTempHighF;
                            tempLow = forTempLowF;
                            writeToPage();
                        }



                    });

                    function writeToPage() {
                        $('#degree').html(degreeSymbolBar);
                        $('#degree2').html(degreeSymbol);
                        $('#temp').html(Math.round(temp));
                        $('#feelsLike').html(Math.round(feels));
                        $('#wind').html(wind + windDir);
                        $('#humidity').html(humidity);
                        $('#precip').html(forPOP1 + '%');
                        $('#icon').html('<img src="' + icon + '" />');
                        $('#location').html(city + ' ' + state);
                        $('#weather').html(weather);
                        $('#highLow').html('H' + tempHigh + ' | ' + 'L' + tempLow);
                        $('#switchMetric').html(switchSymbol);




                        // 5 day forcast

                        // i = 1 to start the forcast the day after today
                        for(var i = 1; i < 6; i++) {

                            futureTempHighF = parsed_json.forecast.simpleforecast.forecastday[i].high.fahrenheit;
                            futureTempHighC = parsed_json['forecast']['simpleforecast']['forecastday'][i]['high']['celsius'];
                            futureTempLowF = parsed_json.forecast.simpleforecast.forecastday[i].low.fahrenheit;
                            futureTempLowC = parsed_json['forecast']['simpleforecast']['forecastday'][i]['low']['celsius'];
                            var futureWeather = parsed_json['forecast']['simpleforecast']['forecastday'][i]['conditions'];
                            var futureImage = parsed_json['forecast']['simpleforecast']['forecastday'][i]['icon_url'];
                            var futureDay = parsed_json['forecast']['simpleforecast']['forecastday'][i]['date']['weekday_short'];
                            var futureMO = parsed_json['forecast']['simpleforecast']['forecastday'][i]['date']['month'];
                            var futureDY = parsed_json['forecast']['simpleforecast']['forecastday'][i]['date']['day'];
                            var futurePOP = parsed_json['forecast']['simpleforecast']['forecastday'][i]['pop'];

                            if (unit == "f") {
                                futureTempHigh = futureTempHighF;
                                futureTempLow = futureTempLowF;
                            } else {
                                futureTempHigh = futureTempHighC;
                                futureTempLow = futureTempLowC;
                            }

                            $('#forDate' + i).html(futureDay + '<br />' + futureMO + '/' + futureDY);
                            $('#forTemp' + i).html(futureTempHigh + ' | ' + futureTempLow);
                            $('#forImage' + i).html('<img src="' + futureImage + '" />');
                            $('#forWeather' + i).html(futureWeather);
                            $('#forPop' + i).html(futurePOP + '% Precip');

                        }
                    }

                },

                // Trying to figure out the error function on the api
                error : function(e) {
                    alert(e);
                },

                timeout: function(e) {
                    alert(e);
                }


            });



        }
        $(document).ready(function($) {
            // used to pass the location to the getWeather()
            var locationUrl;

            //gets location when entered in the location input field and passes into getweather()
            $('#addressForm').submit(function(){

                var location = $('#stateInput').val();
                // regex to replace spaces in city, state, country with %20 and add .json
                var locationUrl = location.replace(/,\s/g, "%20") + '.json';

                getWeather(locationUrl);

                //gets the value to clear what is in the field
                $('#stateInput').val('');

                //prevents the form from refreshing the page
                event.preventDefault();

            });



            //if no location set, pull auto ip and display weather
            if (!locationUrl) {

                //location pulled from weather undergrounds auto ip location and passes into getweather()
                var locationUrl = 'autoip.json';
                getWeather(locationUrl);

                // for smaller screens, change the css of the form
                if ( $(window).width() < 514) {
                    $('form').removeClass('pull-right');
                    $('form').addClass('center-block text-center');
                }

            }


            // wunderground.com autocomplete url https://www.wunderground.com/weather/api/d/docs?d=autocomplete-api&MR=1
            //Using http://easyautocomplete.com/guide#sec-data-remote

            //Auto complete shows when typing
            var options = {

                url: function(phrase) {
                    return "http://autocomplete.wunderground.com/aq?query=" + phrase + "&cb=call=?";
                },

                placeholder: "City, State or Zip Code",

                //json returned with RESULTS object
                listLocation: "RESULTS",

                getValue: "name",

                // delay in results by ms
                requestDelay: 300,

                //matches the query by putting text in bold
                list: {
                    match: {
                        enabled: true
                    }
                }
            };

            $("#stateInput").easyAutocomplete(options);

        });




    </script>

    <style type="text/css">
        body {
            background: url(images/sunny-fotonin-com.jpg) no-repeat center center fixed;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        }

        .outline {
            text-shadow:
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
        }

        .ui-autocomplete {
            color: blue;
            list-style-type: none;
            background-color: white;
            max-width: 250px;
        }

    </style>

{% endblock %}

{% block content %}
    <main id="home">
        <div class="container">

            <h1 class="text-center outline">Your Local Current Weather</h1>

            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <div class="transparent well">
                        <div class="row">
                            <div class="col-md-5">
                                <p style="font-size: 25px;">
                                    <span id="location"></span>
                                </p>
                            </div>
                            <div class="col-md-7">
                                <form class="form-inline pull-right" id="addressForm">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="stateInput" title="Enter Your City, State or City, Country, or Zip/Postal Code" />
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-2">
                                <p>
                                    <span id="icon"></span> <br />
                                    <span id="weather"></span>
                                </p>
                            </div>
                            <div class="col-md-5"
                            <p>
                                <span id="temp" style="font-size: 3.5em;"></span>
                                <span id="degree"></span>
                                <a id="switchMetric"></a>
                                <br />

                                <span>Feels like: </span>
                                <span id="feelsLike"></span>
                                <span id="degree2" class="small"></span>
                                <br />

                                <span id="highLow"></span>
                            </p>
                        </div>
                        <div class="col-md-5">
                            <p>
                                Chance of Precip: <span id="precip">0%</span><br />
                                Humidity: <span id="humidity">0%</span><br />
                                Wind: <span id="wind">0 mph </span><br />
                            </p>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-offset-1 col-md-2 small">
                            <p id="day1">
                                <span id="forDate1"></span> <br />
                                <span id="forTemp1"></span> <br />
                                <span id="forImage1"></span><br />
                                <span id="forWeather1"></span><br />
                                <span id="forPop1"></span>
                            </p>
                        </div>
                        <div class="col-md-2 small">
                            <p id="day2">
                                <span id="forDate2"></span> <br />
                                <span id="forTemp2"></span> <br />
                                <span id="forImage2"></span> <br />
                                <span id="forWeather2"></span> <br />
                                <span id="forPop2"></span>
                            </p>
                        </div>
                        <div class="col-md-2 small">
                            <p id="day3">
                                <span id="forDate3"></span> <br />
                                <span id="forTemp3"></span> <br />
                                <span id="forImage3"></span> <br />
                                <span id="forWeather3"></span> <br />
                                <span id="forPop3"></span>
                            </p>
                        </div>
                        <div class="col-md-2 small">
                            <p id="day4">
                                <span id="forDate4"></span> <br />
                                <span id="forTemp4"></span> <br />
                                <span id="forImage4"></span> <br />
                                <span id="forWeather4"></span> <br />
                                <span id="forPop4"></span>
                            </p>
                        </div>
                        <div class="col-md-2 small">
                            <p id="day5">
                                <span id="forDate5"></span> <br />
                                <span id="forTemp5"></span> <br />
                                <span id="forImage5"></span> <br />
                                <span id="forWeather5"></span> <br />
                                <span id="forPop5"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2 col-md-offset-5">
                <p class='outline'>Weather api data provided by: <a href="http://www.wunderground.com/?apiref=57a762c18067d252">
                        <img src="../images/wundergroundLogo_4c.png" alt="Weather Underground" class='img-responsive' title='Weather Underground Logo' /></a>
                </p>
            </div>
        </div>
        </div>
    </main>

{% endblock %}